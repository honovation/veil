#!/bin/bash

if [[ $1 == :* ]] ; then
    COLON_VEIL_SERVER=$1
    shift
    VEIL_SERVER=${COLON_VEIL_SERVER:1} veil $@ || exit $?
    exit 0
fi

if [ -z "$VEIL_HOME" ] ; then
    export VEIL_HOME=$(pwd)
fi
if [ ! -d $VEIL_HOME/env/bin ] ; then
    if [[ $1 != install ]] ; then
        echo "VEIL_HOME is invalid"
        exit 1
    fi
fi
if [ -z `readlink $0` ] ; then
    BIN_DIR=$(cd `dirname $0` && pwd)
else
    BIN_DIR=$(dirname $(readlink $0))
fi
export VEIL_FRAMEWORK_HOME=$(dirname $BIN_DIR)

if [ -f $VEIL_HOME/env/bin/activate ] ; then
    source $VEIL_HOME/env/bin/activate
fi

function veil_init {
    find $VEIL_FRAMEWORK_HOME -type f -name "*.pyc" -delete
    find $VEIL_HOME -type f -name "*.pyc" -delete
    sudo apt-get install -y python-dev python-virtualenv
    if [ ! -f /usr/bin/veil ]; then
        sudo ln -s $VEIL_FRAMEWORK_HOME/bin/veil /usr/bin/veil
    fi
    if [ ! -d $VEIL_HOME/src ]; then
        mkdir $VEIL_HOME/src
        touch $VEIL_HOME/src/__veil__.py
    fi
    if [ ! -d $VEIL_HOME/env ]; then
        virtualenv env
        echo "$VEIL_FRAMEWORK_HOME/src" > env/lib/python2.7/site-packages/veil.pth
        echo "$VEIL_HOME/src" >> env/lib/python2.7/site-packages/veil.pth
        source $VEIL_HOME/env/bin/activate
    fi
    if [ ! -f $VEIL_HOME/.git/hooks/pre-commit ]; then
        ln -s $VEIL_FRAMEWORK_HOME/src/discipline_coach.py $VEIL_HOME/.git/hooks/pre-commit
    fi
}

case "$1" in
    execute)
        shift
        exec $@
        ;;
    sleep)
        shift
        sleep $1
        shift
        exec $@
        ;;
    up)
        shift
        find $VEIL_FRAMEWORK_HOME -type f -name "*.pyc" -delete
        find $VEIL_HOME -type f -name "*.pyc" -delete
        exec veil environment supervisor up $@
        ;;
    down)
        exec veil environment supervisor down
        ;;
    install-program)
        shift
        exec python -m veil_installer --installer-provider veil.environment.supervisor program?$@
        ;;
    install)
        shift
        veil_init
        exec python -m veil_installer --installer-provider veil.environment.supervisor veil_server $@
        ;;
    deploy-env)
        shift
        exec veil environment deployment deploy-env $@
        ;;
    deploy-server)
        shift
        exec veil environment deployment deploy-server $@
        ;;
    deploy)
        shift
        exec veil environment deployment deploy $@
        ;;
    migrate)
        exec veil environment migration migrate
        ;;
    pull)
        exec veil development git pull
        ;;
    self-check)
        shift
        exec veil :test development self-checker self-check $@
        ;;
    check)
        shift
        exec veil :test development self-checker check $@
        ;;
    *)
        exec python -m veil $@
esac